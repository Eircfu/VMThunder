#!/usr/bin/env python

import sys
from oslo.config import cfg

from vmthunder import compute
from vmthunder.common import wsgi
from vmthunder.openstack.common import log as logging

fcg_opts = [
    cfg.StrOpt('fcg_name',
               default='fcg',
               help='The name of the Flashcache Group'),
    cfg.ListOpt('fcg_ssds',
                default=['/dev/loop1'],
                help='The devices of SSDs to use to create the FCG, '
                     'the parameter of \'ssds\' can fill in one '
                     'or more, splited by \',\''),
    cfg.StrOpt('fcg_blocksize',
               default='4k',
               help='The block size of the FCG'),
    cfg.StrOpt('fcg_pattern',
               default='back',
               help='The cache mode for the FCG'),
]

master_opts = [
    cfg.StrOpt('master_host',
               default=None,
               help='Master\'s host to provide Voltclient service'),
    cfg.StrOpt('master_port',
               default=None,
               help='Master\'s port to provide Voltclient service'),
]

cinder_opts = [
    cfg.StrOpt('cinder_host',
               default=None,
               help='Cinder\'s host to provide Volume service'),
    cfg.StrOpt('cinder_port',
               default=None,
               help='Cinder\'s port to provide Volume service'),
]

CONF = cfg.CONF
CONF.register_opts(fcg_opts)
CONF.register_opts(master_opts)
CONF.register_opts(cinder_opts)

def start():
    cn = compute.Compute(CONF.fcg_name, CONF.fcg_ssds, CONF.fcg_blocksize, CONF.fcg_pattern)
    server = wsgi.Server('vmthunder-api')  # or path = ${a specified path} like '/root/VMThunder/etc/api-paste.ini'
    server.start()
    server.wait()

if __name__ == '__main__':
    CONF(sys.argv[1:], project='vmthunder',
         default_config_files = ['../etc/vmthunder.conf'])
    #print CONF.fcg_name, CONF.fcg_ssds, CONF.fcg_blocksize, CONF.fcg_pattern
    logging.setup('vmthunder')
    start()
