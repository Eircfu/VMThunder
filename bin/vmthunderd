#/usr/bin/env python

import sys
import eventlet
sys.path.append("..")

from libfcg.fcg import FCG
from vmthunder.computenode import ComputeNode
from vmthunder.getconf import GetConf
from vmthunder import wsgi
from paste.deploy import loadapp

class APIService(object):
    def __init__(self, host='0.0.0.0', port=8001,
                       app_name='vmthunder-api',
                       config_path='/root/VMThunder/vmthunder/api-paste.ini'):
        self.host = host
        self.port = port
        self.app_name = app_name
        self.config_path = config_path
        self.app = loadapp('config:%s' %os.path.abspath(self.config_file), self.app_name)
    	wsgi.server(eventlet.listen((self.host, self.port)), self.app)
        
        self.server = wsgi.Server(name,
                                  self.app,
                                  host=self.host,
                                  port=self.port)
    def start(self):
        self.server.start()
        self.port = self.server.port
    def stop(self):
        self.server.stop()
    def wait(self):
        self.server.wait()

def serve():
    apiservice = APIService()
    apiservice.start()

def main():
    gc = GetConf('../etc/vmthunder/vmthunder.conf')
    name = gc.get_fcg_name()
    ssds = gc.get_fcg_ssds()
    blocksize = gc.get_fcg_blocksize()
    pattern = gc.get_fcg_pattern()
    #print name, ssds, blocksize, pattern
    
    fcg = FCG(name)
    fcg.create_group(ssds, blocksize, pattern)

if __name__ == '__main__':
    #main()
    serve()   
